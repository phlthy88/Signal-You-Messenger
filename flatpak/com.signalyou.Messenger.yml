app-id: com.signalyou.Messenger
runtime: org.gnome.Platform
runtime-version: '46'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable

command: signal-you-messenger

finish-args:
  # Wayland and X11 support
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # Audio support for voice messages
  - --socket=pulseaudio
  # Network access for Signal servers
  - --share=network
  # GPU acceleration
  - --device=dri
  # File access for attachments (portal-based)
  - --filesystem=xdg-download:rw
  # Desktop notifications
  - --talk-name=org.freedesktop.Notifications
  # Background portal for receiving messages
  - --talk-name=org.freedesktop.portal.Background
  # Secret storage for credentials
  - --talk-name=org.freedesktop.secrets
  # XDG portals
  - --talk-name=org.freedesktop.portal.*

build-options:
  append-path: /usr/lib/sdk/rust-stable/bin
  env:
    CARGO_HOME: /run/build/signal-you-messenger/cargo
    RUST_BACKTRACE: '1'

cleanup:
  - /include
  - /lib/pkgconfig
  - /share/man
  - '*.a'
  - '*.la'

modules:
  # SQLCipher for encrypted database
  - name: sqlcipher
    buildsystem: autotools
    config-opts:
      - --enable-tempstore=yes
      - --disable-tcl
      - CFLAGS=-DSQLITE_HAS_CODEC
      - LDFLAGS=-lcrypto
    sources:
      - type: archive
        url: https://github.com/sqlcipher/sqlcipher/archive/v4.5.6.tar.gz
        sha256: e4a527e38e67090c1d2dc41df28270d16c15f7ca5210a3e7ec4c4b8fda36e28f

  # Blueprint compiler for UI templates
  - name: blueprint-compiler
    buildsystem: meson
    sources:
      - type: archive
        url: https://gitlab.gnome.org/jwestman/blueprint-compiler/-/archive/v0.12.0/blueprint-compiler-v0.12.0.tar.gz
        sha256: c1e944b2d9e2c6cb7ddf13eb45b3c0aa8d6f6e69f4fb1ea7fc792bdc2e5e5d1a
    cleanup:
      - '*'

  # Main application
  - name: signal-you-messenger
    buildsystem: meson
    config-opts:
      - -Dprofile=default
    build-options:
      env:
        CARGO_NET_OFFLINE: 'true'
    sources:
      - type: dir
        path: ..
      # Generated cargo sources for offline build
      # Generate with: flatpak-cargo-generator.py Cargo.lock -o flatpak/cargo-sources.json
      - cargo-sources.json
